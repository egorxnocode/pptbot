services:
  # ============================================
  # TELEGRAM BOT
  # ============================================
  bot:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: pptbot-telegram-bot
    restart: unless-stopped
    environment:
      # Telegram Bot
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      
      # Supabase (ваш развернутый сервер)
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_KEY: ${SUPABASE_KEY}
      SUPABASE_TABLE: ${SUPABASE_TABLE:-users}
      SUPABASE_PROMPTS_TABLE: ${SUPABASE_PROMPTS_TABLE:-prompts}
      SUPABASE_N8N_RESPONSES_TABLE: ${SUPABASE_N8N_RESPONSES_TABLE:-n8n_responses}
      SUPABASE_POSTS_TABLE: ${SUPABASE_POSTS_TABLE:-posts}
      
      # OpenAI
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      
      # n8n Webhooks (5 отдельных для каждого типа)
      N8N_WEBHOOK_OSEBE: ${N8N_WEBHOOK_OSEBE}
      N8N_WEBHOOK_POST: ${N8N_WEBHOOK_POST}
      N8N_WEBHOOK_BLUEBUTT: ${N8N_WEBHOOK_BLUEBUTT}
      N8N_WEBHOOK_ANONS: ${N8N_WEBHOOK_ANONS}
      N8N_WEBHOOK_PRODAJ: ${N8N_WEBHOOK_PRODAJ}
    ports:
      # Webhook сервер для приема ответов от n8n
      - "${WEBHOOK_PORT:-8080}:8080"
    volumes:
      # Медиафайлы (видео)
      - ./media:/app/media
      # Логи бота
      - ./logs:/app/logs
      # Временные файлы (голосовые)
      - ./temp:/app/temp
    # Если Supabase и n8n в той же сети Docker, раскомментируйте:
    # networks:
    #   - external-network
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3

# Если нужно подключиться к внешней сети Docker (где Supabase и n8n)
# networks:
#   external-network:
#     external: true
#     name: your-network-name
