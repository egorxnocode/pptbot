#!/bin/bash

# ============================================================
# 🔄 Скрипт быстрого обновления бота PPTbot на сервере
# ============================================================

set -e

echo "🔄 ОБНОВЛЕНИЕ БОТА PPTbot"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

cd /opt/pptbot

# 1. Получаем последние изменения
echo "1️⃣ Получение обновлений из GitHub..."
git pull origin main
echo "✅ Код обновлен"
echo ""

# 2. Останавливаем контейнер
echo "2️⃣ Остановка контейнера..."
docker-compose down
echo "✅ Контейнер остановлен"
echo ""

# 3. Пересборка образа без кэша
echo "3️⃣ Пересборка образа (это займет 1-2 минуты)..."
docker-compose build --no-cache
echo "✅ Образ пересобран"
echo ""

# 4. Запуск контейнера
echo "4️⃣ Запуск контейнера..."
docker-compose up -d
echo "✅ Контейнер запущен"
echo ""

# 5. Ожидание запуска
echo "5️⃣ Ожидание запуска (10 секунд)..."
sleep 10
echo ""

# 6. Проверка логов
echo "6️⃣ Проверка логов:"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
docker-compose logs --tail=30 bot
echo ""

# 7. Статус
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "✅ ОБНОВЛЕНИЕ ЗАВЕРШЕНО!"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "📊 Статус контейнера:"
docker-compose ps
echo ""
echo "📝 Для просмотра логов в реальном времени:"
echo "   docker-compose logs -f bot"
echo ""
echo "🔍 Для просмотра логов через скрипт:"
echo "   ./logs.sh live"
echo "   ./logs.sh errors"
echo ""

